// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Waitlist entry model
model WaitlistEntry {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String?
  zipCode          String?

  // Product interests
  interestCorn     Boolean   @default(false)
  interestButter   Boolean   @default(false)
  interestFlour    Boolean   @default(false)
  interestVariety  Boolean   @default(false)

  expectedQuantity String?

  // Tracking fields
  source           String?   // utm_source
  medium           String?   // utm_medium
  campaign         String?   // utm_campaign
  referrer         String?   // HTTP referrer

  // Status
  verified         Boolean   @default(false)
  unsubscribed     Boolean   @default(false)

  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  notes            Note[]
  emailLogs        EmailLog[]

  @@index([email])
  @@index([createdAt])
  @@index([zipCode])
}

// Admin user model for authentication
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // Hashed password
  role          UserRole  @default(VIEWER)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessions      Session[]
  notes         Note[]

  @@index([email])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

// Session management for admin users
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Notes/comments on waitlist entries
model Note {
  id              String         @id @default(cuid())
  content         String
  waitlistEntryId String
  userId          String

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  waitlistEntry   WaitlistEntry  @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [userId], references: [id])

  @@index([waitlistEntryId])
  @@index([userId])
}

// Email activity log
model EmailLog {
  id              String         @id @default(cuid())
  waitlistEntryId String
  type            EmailType
  subject         String
  status          EmailStatus    @default(PENDING)
  sentAt          DateTime?
  error           String?

  createdAt       DateTime       @default(now())

  waitlistEntry   WaitlistEntry  @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)

  @@index([waitlistEntryId])
  @@index([type])
  @@index([status])
}

enum EmailType {
  WELCOME
  UPDATE
  LAUNCH
  MARKETING
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

// Customer model - synced from Clerk
model Customer {
  id            String    @id @default(cuid())
  clerkUserId   String    @unique  // Links to Clerk user ID
  email         String    @unique
  firstName     String?
  lastName      String?

  // User tracking fields
  lastLoginAt   DateTime?
  signupSource  String?   // utm_source for tracking

  // Metadata from Clerk
  publicMetadata  Json?
  privateMetadata Json?

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  orders        Order[]
  addresses     Address[]

  @@index([clerkUserId])
  @@index([email])
}

// Shipping/billing addresses for customers
model Address {
  id          String   @id @default(cuid())
  customerId  String

  // Address fields
  firstName   String
  lastName    String
  street      String
  street2     String?
  city        String
  state       String
  zip         String
  country     String   @default("US")
  phone       String?

  // Address type
  isDefault   Boolean  @default(false)
  type        AddressType @default(BOTH)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([isDefault])
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

// Order tracking for when we launch
model Order {
  id               String    @id @default(cuid())
  orderNumber      String    @unique
  email            String

  // Customer link (optional for guest checkouts)
  customerId       String?
  customer         Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Customer details
  customerName     String
  shippingAddress  Json
  billingAddress   Json

  // Order details
  items            Json
  subtotal         Int       // In cents
  shipping         Int       // In cents
  tax              Int       // In cents
  total            Int       // In cents

  // Payment
  stripePaymentId  String?
  paymentStatus    PaymentStatus @default(PENDING)

  // Fulfillment
  status           OrderStatus   @default(PENDING)
  trackingNumber   String?
  carrier          String?

  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  shippedAt        DateTime?
  deliveredAt      DateTime?

  @@index([email])
  @@index([orderNumber])
  @@index([status])
  @@index([customerId])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}