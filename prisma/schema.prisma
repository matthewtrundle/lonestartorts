generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Address {
  id         String      @id
  customerId String
  firstName  String
  lastName   String
  city       String
  state      String
  country    String      @default("US")
  phone      String?
  isDefault  Boolean     @default(false)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime
  street     String
  street2    String?
  type       AddressType @default(BOTH)
  zip        String
  Customer   Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([isDefault])
}

model Customer {
  id              String    @id
  clerkUserId     String    @unique
  email           String    @unique
  firstName       String?
  lastName        String?
  lastLoginAt     DateTime?
  signupSource    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  privateMetadata Json?
  publicMetadata  Json?
  Address         Address[]
  Order           Order[]

  @@index([clerkUserId])
  @@index([email])
}

model EmailLog {
  id              String        @id
  waitlistEntryId String
  type            EmailType
  subject         String
  status          EmailStatus   @default(PENDING)
  sentAt          DateTime?
  error           String?
  createdAt       DateTime      @default(now())
  WaitlistEntry   WaitlistEntry @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([type])
  @@index([waitlistEntryId])
}

model Note {
  id              String        @id
  content         String
  waitlistEntryId String
  userId          String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  User            User          @relation(fields: [userId], references: [id])
  WaitlistEntry   WaitlistEntry @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([waitlistEntryId])
}

model Order {
  id               String            @id
  orderNumber      String            @unique
  customerId       String?
  email            String
  subtotal         Int
  shipping         Int
  tax              Int
  total            Int
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  shippedAt        DateTime?
  deliveredAt      DateTime?
  carrier          String?
  paymentStatus    PaymentStatus     @default(PENDING)
  stripePaymentId  String?
  trackingNumber   String?
  status           OrderStatus       @default(PENDING)
  shippingName     String?
  shippingAddress1 String?
  shippingAddress2 String?
  shippingCity     String?
  shippingState    String?
  shippingZip      String?
  shippingCountry  String?
  shippingPhone    String?
  labelUrl         String?
  Customer         Customer?         @relation(fields: [customerId], references: [id])
  OrderItem        OrderItem[]
  CustomerFeedback CustomerFeedback?

  @@index([customerId])
  @@index([email])
  @@index([orderNumber])
  @@index([status])
}

model CustomerFeedback {
  id            String    @id @default(uuid())
  orderId       String    @unique
  orderNumber   String
  email         String
  customerName  String?
  feedbackToken String    @unique
  rating        Int?
  comment       String?
  submittedAt   DateTime?
  emailSentAt   DateTime?
  couponCode    String?   @unique
  couponUsed    Boolean   @default(false)
  couponUsedAt  DateTime?
  createdAt     DateTime  @default(now())
  expiresAt     DateTime
  Order         Order     @relation(fields: [orderId], references: [id])

  @@index([feedbackToken])
  @@index([couponCode])
  @@index([email])
}

model OrderItem {
  id        String   @id
  orderId   String
  sku       String?
  name      String
  price     Int
  quantity  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  Order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

// Spin-the-wheel entries for TikTok gamification
model SpinWheelEntry {
  id        String    @id @default(uuid())
  email     String
  prize     String    // 'jackpot', 'free_sauce', 'free_shipping', 'bonus_tortillas', 'five_off'
  code      String    @unique
  used      Boolean   @default(false)
  usedAt    DateTime?
  expiresAt DateTime
  createdAt DateTime  @default(now())
  utmSource String?   // Track which campaign

  // Drip campaign relation
  dripCampaign DripCampaignProgress?

  @@index([email])
  @@index([code])
  @@index([expiresAt])
}

// ===========================================
// DRIP CAMPAIGN SYSTEM
// ===========================================

// Tracks progress of leads through the drip email sequence
model DripCampaignProgress {
  id                String              @id @default(uuid())
  spinWheelEntryId  String              @unique
  spinWheelEntry    SpinWheelEntry      @relation(fields: [spinWheelEntryId], references: [id])
  email             String              // Denormalized for easy querying
  status            DripCampaignStatus  @default(ACTIVE)
  currentStep       Int                 @default(1) // 1-6, which email is next
  lastEmailSentAt   DateTime?
  nextEmailDueAt    DateTime
  enrolledAt        DateTime            @default(now())
  convertedAt       DateTime?
  unsubscribedAt    DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  emailLogs         DripEmailLog[]

  @@index([status, nextEmailDueAt])
  @@index([email])
}

// Individual email log for drip campaign
model DripEmailLog {
  id              String               @id @default(uuid())
  dripCampaignId  String
  dripCampaign    DripCampaignProgress @relation(fields: [dripCampaignId], references: [id], onDelete: Cascade)
  emailNumber     Int                  // 1-6
  subject         String
  sentAt          DateTime             @default(now())
  openedAt        DateTime?
  clickedAt       DateTime?
  discountCode    String?              // Generated code for emails 4-6

  @@index([dripCampaignId])
}

enum DripCampaignStatus {
  ACTIVE
  COMPLETED
  CONVERTED
  UNSUBSCRIBED
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model Order_backup_1762893219972 {
  id              String?
  orderNumber     String?
  customerId      String?
  email           String?
  subtotal        Int?
  shipping        Int?
  tax             Int?
  total           Int?
  createdAt       DateTime?
  updatedAt       DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  billingAddress  Json?
  carrier         String?
  customerName    String?
  items           Json?
  paymentStatus   PaymentStatus?
  shippingAddress Json?
  stripePaymentId String?
  trackingNumber  String?
  status          OrderStatus?

  @@ignore
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id        String    @id
  email     String    @unique
  name      String?
  password  String?
  role      UserRole  @default(VIEWER)
  createdAt DateTime  @default(now())
  updatedAt DateTime
  Note      Note[]
  Session   Session[]

  @@index([email])
}

model WaitlistEntry {
  id               String     @id
  email            String     @unique
  name             String?
  zipCode          String?
  interestCorn     Boolean    @default(false)
  interestButter   Boolean    @default(false)
  interestFlour    Boolean    @default(false)
  interestVariety  Boolean    @default(false)
  expectedQuantity String?
  source           String?
  medium           String?
  campaign         String?
  referrer         String?
  verified         Boolean    @default(false)
  unsubscribed     Boolean    @default(false)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime
  EmailLog         EmailLog[]
  Note             Note[]

  @@index([createdAt])
  @@index([email])
  @@index([zipCode])
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum EmailType {
  WELCOME
  UPDATE
  LAUNCH
  MARKETING
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

// ===========================================
// WHOLESALE SYSTEM MODELS
// ===========================================

// Stores wholesale inquiry submissions from the public form
model WholesaleInquiry {
  id              String              @id @default(uuid())
  businessName    String
  contactName     String
  email           String
  phone           String?
  businessType    String
  estimatedVolume String
  message         String?
  status          InquiryStatus       @default(PENDING)
  reviewedAt      DateTime?
  reviewedBy      String?
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // If approved, links to the created client
  wholesaleClient WholesaleClient?

  @@index([status])
  @@index([email])
  @@index([createdAt])
}

// Approved wholesale customer account
model WholesaleClient {
  id                  String                @id @default(uuid())
  businessName        String
  contactName         String
  email               String                @unique
  phone               String?
  businessType        String

  // Stripe integration
  stripeCustomerId    String?               @unique

  // Pricing and terms
  pricingTier         PricingTier           @default(STANDARD)
  discountPercent     Int                   @default(0)
  paymentTerms        PaymentTerms          @default(DUE_ON_RECEIPT)
  creditLimit         Int?

  // Shipping address
  shippingName        String?
  shippingAddress1    String?
  shippingAddress2    String?
  shippingCity        String?
  shippingState       String?
  shippingZip         String?
  shippingCountry     String                @default("US")

  // Billing address (if different)
  billingName         String?
  billingAddress1     String?
  billingAddress2     String?
  billingCity         String?
  billingState        String?
  billingZip          String?
  billingCountry      String                @default("US")

  // Account status
  status              ClientStatus          @default(ACTIVE)
  accountNotes        String?

  // Timestamps
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  approvedAt          DateTime?
  approvedBy          String?

  // Relations
  inquiryId           String?               @unique
  inquiry             WholesaleInquiry?     @relation(fields: [inquiryId], references: [id])
  orders              WholesaleOrder[]
  subscriptions       WholesaleSubscription[]

  @@index([status])
  @@index([email])
  @@index([stripeCustomerId])
}

// Individual wholesale order/invoice
model WholesaleOrder {
  id                  String                   @id @default(uuid())
  orderNumber         String                   @unique
  clientId            String

  // Stripe invoice reference
  stripeInvoiceId     String?                  @unique
  stripeInvoiceUrl    String?
  stripeInvoiceNumber String?

  // Order details
  subtotal            Int
  discount            Int                      @default(0)
  shipping            Int                      @default(0)
  tax                 Int                      @default(0)
  total               Int

  // Payment tracking
  paymentStatus       WholesalePaymentStatus   @default(DRAFT)
  paymentTerms        PaymentTerms
  dueDate             DateTime?
  paidAt              DateTime?

  // Fulfillment
  orderStatus         WholesaleOrderStatus     @default(PENDING)
  shippedAt           DateTime?
  deliveredAt         DateTime?
  trackingNumber      String?
  carrier             String?

  // Shipping address (snapshot at order time)
  shippingName        String?
  shippingAddress1    String?
  shippingAddress2    String?
  shippingCity        String?
  shippingState       String?
  shippingZip         String?
  shippingCountry     String?

  // Notes
  internalNotes       String?
  customerNotes       String?

  // Timestamps
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  invoiceSentAt       DateTime?

  // Relations
  client              WholesaleClient          @relation(fields: [clientId], references: [id])
  items               WholesaleOrderItem[]
  subscription        WholesaleSubscription?   @relation(fields: [subscriptionId], references: [id])
  subscriptionId      String?

  @@index([clientId])
  @@index([paymentStatus])
  @@index([orderStatus])
  @@index([stripeInvoiceId])
  @@index([createdAt])
}

// Line items for wholesale orders
model WholesaleOrderItem {
  id          String          @id @default(uuid())
  orderId     String
  sku         String?
  name        String
  description String?
  quantity    Int
  unitPrice   Int
  totalPrice  Int
  createdAt   DateTime        @default(now())

  order       WholesaleOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

// Recurring subscription for wholesale clients
model WholesaleSubscription {
  id                   String             @id @default(uuid())
  clientId             String

  // Stripe subscription reference
  stripeSubscriptionId String?            @unique
  stripePriceId        String?

  // Subscription details
  name                 String
  status               SubscriptionStatus @default(ACTIVE)

  // Billing cycle
  interval             BillingInterval    @default(MONTHLY)
  intervalCount        Int                @default(1)

  // Next billing/order
  nextBillingDate      DateTime?
  lastBilledAt         DateTime?

  // Default order items (JSON for flexibility)
  defaultItems         Json

  // Pricing
  subtotal             Int
  discount             Int                @default(0)
  shipping             Int                @default(0)
  estimatedTotal       Int

  // Configuration
  autoSendInvoice      Boolean            @default(true)
  pausedUntil          DateTime?

  // Timestamps
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  cancelledAt          DateTime?

  // Relations
  client               WholesaleClient    @relation(fields: [clientId], references: [id])
  orders               WholesaleOrder[]

  @@index([clientId])
  @@index([status])
  @@index([nextBillingDate])
}

// ===========================================
// WHOLESALE ENUMS
// ===========================================

enum InquiryStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  NEEDS_INFO
}

enum ClientStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum PricingTier {
  STANDARD
  SILVER
  GOLD
  PLATINUM
  CUSTOM
}

enum PaymentTerms {
  DUE_ON_RECEIPT
  NET_7
  NET_15
  NET_30
  NET_45
  NET_60
}

enum WholesalePaymentStatus {
  DRAFT
  PENDING
  PAID
  PARTIAL
  OVERDUE
  VOID
  REFUNDED
}

enum WholesaleOrderStatus {
  PENDING
  PROCESSING
  READY
  SHIPPED
  DELIVERED
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  PAST_DUE
}

enum BillingInterval {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
}

// ===========================================
// VERCEL WEB ANALYTICS DRAIN
// ===========================================

model AnalyticsEvent {
  id            String   @id @default(uuid())
  receivedAt    DateTime @default(now())

  // Core event data
  eventType     String   // "pageview" or "event"
  eventName     String?  // for custom events
  timestamp     BigInt   // Unix timestamp from Vercel

  // Page info
  path          String?
  route         String?
  origin        String?
  referrer      String?
  queryParams   String?  // contains utm_source, utm_medium, etc.

  // Session/device
  sessionId     BigInt?
  deviceId      BigInt?

  // Geo
  country       String?
  region        String?
  city          String?

  // Device/browser
  osName        String?
  clientName    String?  // browser name
  deviceType    String?  // desktop, mobile, tablet

  // Full payload for future use
  rawJson       Json

  // Dedup hash
  payloadHash   String?  @unique

  @@index([receivedAt])
  @@index([path])
  @@index([referrer])
  @@index([country])
  @@index([eventType])
  @@index([timestamp])
}

// ===========================================
// DISCOUNT CODE MANAGEMENT SYSTEM
// ===========================================

model DiscountCode {
  id                 String    @id @default(uuid())
  code               String    @unique
  name               String
  description        String?

  // Source tracking - where did this code originate
  source             DiscountSource @default(ADMIN)
  sourceRef          String?    // Reference to source record (e.g., spinWheelEntryId)

  // Validity
  isActive           Boolean   @default(true)
  startsAt           DateTime?
  expiresAt          DateTime?

  // Global restrictions
  minOrderAmount     Int?      // Minimum subtotal in cents
  maxDiscountAmount  Int?      // Cap on total discount value

  // Usage limits
  maxUsageTotal      Int?      // null = unlimited total uses
  maxUsagePerEmail   Int       @default(1)  // Uses per email
  currentUsageCount  Int       @default(0)

  // Targeting
  firstOrderOnly     Boolean   @default(false)

  // Combination rules
  stackable          Boolean   @default(false)  // Can be combined with other codes
  priority           Int       @default(0)      // Higher priority wins for non-stackable

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  createdBy          String?   // Admin user who created it

  rules              DiscountRule[]
  restrictions       DiscountRestriction[]
  usages             DiscountUsage[]

  @@index([code])
  @@index([isActive])
  @@index([source])
  @@index([expiresAt])
}

model DiscountRule {
  id                 String       @id @default(uuid())
  discountId         String

  type               RuleType

  // For PERCENTAGE and FIXED_AMOUNT rules
  value              Int?         // Percentage (1-100) or cents
  maxDiscount        Int?         // Cap for percentage discounts

  // For BOGO rules
  buyProductSku      String?      // SKU customer must buy
  buyQuantity        Int?         // Minimum quantity to trigger BOGO
  getProductSku      String?      // SKU customer receives
  getQuantity        Int?         // How many they receive
  getDiscountPct     Int?         // Discount on free item (100 = free)

  // Tier threshold - for tiered discounts
  minOrderAmount     Int?         // Minimum order to qualify for this rule
  priority           Int          @default(0) // Higher priority checked first

  createdAt          DateTime     @default(now())

  discount           DiscountCode @relation(fields: [discountId], references: [id], onDelete: Cascade)

  @@index([discountId])
  @@index([type])
}

model DiscountRestriction {
  id                 String       @id @default(uuid())
  discountId         String

  type               RestrictionType
  value              String       // SKU or email domain
  include            Boolean      @default(true) // true = only these, false = exclude these

  createdAt          DateTime     @default(now())

  discount           DiscountCode @relation(fields: [discountId], references: [id], onDelete: Cascade)

  @@index([discountId])
  @@index([type])
}

model DiscountUsage {
  id                 String       @id @default(uuid())
  discountId         String
  email              String
  orderId            String?
  orderNumber        String?
  subtotal           Int          // Order subtotal in cents
  discountApplied    Int          // Actual discount amount in cents
  rulesApplied       Json         // Which rules were applied
  usedAt             DateTime     @default(now())

  // Fraud tracking
  ipAddress          String?

  discount           DiscountCode @relation(fields: [discountId], references: [id])

  @@index([discountId])
  @@index([email])
  @@index([orderId])
  @@index([usedAt])
}

enum RuleType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
  BOGO
}

enum RestrictionType {
  PRODUCT_SKU
  EMAIL_DOMAIN
}

enum DiscountSource {
  ADMIN
  SPIN_WHEEL
  FEEDBACK
  DRIP_CAMPAIGN
  SYSTEM
}

// ============================================
// EXIT INTENT SURVEY
// ============================================

model ExitSurveyResponse {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())

  // Where the exit happened
  page        String   // 'cart' or 'checkout'

  // What they selected
  reason      String   // 'price_too_high', 'shipping_expensive', 'just_browsing', 'will_order_later', 'other'
  otherText   String?  // Free text if they selected 'other'

  // Cart context at time of exit
  itemCount   Int
  subtotal    Int      // In cents
  shipping    Int      // In cents
  total       Int      // In cents

  // Traffic source for correlation
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  // Device info
  deviceType  String?  // 'mobile', 'desktop', 'tablet'

  @@index([createdAt])
  @@index([reason])
  @@index([page])
}
